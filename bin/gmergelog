#!/bin/sh
#
# Copyright (C) 2009,2015  Etersoft
# Copyright (C) 2009-2015  Vitaly Lipatov <lav@etersoft.ru>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program. If not, see <http://www.gnu.org/licenses/>.
#

PROGDIR=$(dirname $0)
[ "$PROGDIR" = "." ] && PROGDIR=$(pwd)

. $PROGDIR/giter-common-functions

# Do cherry pick for all commit from git log

if [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
	echo "gmergelog - cherry pick all commits for git log file in reverse order"
	echo "Use: gmergelog file.log"
	echo "Hit: get git log from with $ git log command"
	#echo "     - no options"
	exit
fi

[ -s "$1" ] || fatal "Run me with git log file (use $ git log)"

# Делает cherry-pick для патчей из указанного лога, в обратном порядке
COMMITLIST=`grep "^commit " "$1" | tac | sed -e "s|commit \([0-0a-f]*\)|\1|g"`

[ -n "$COMMITLIST" ] || fatal "There is no git log entries in $1 file"

for i in $COMMITLIST ; do
	git cherry-pick $i || fatal "Cherry pick for commit $i failed. Fix conflicts and run $ git commit FILE(s)"
done
